<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Academia Nova - Secure Portal</title>
    <!-- Add empty favicon to prevent 404 -->
    <link rel="icon" href="data:,">
    <style>
        :root {
            --primary: #4361ee;
            --secondary: #3f37c9;
            --accent: #4895ef;
            --success: #4cc9f0;
            --danger: #f72585;
            --light: #f8f9fa;
            --dark: #212529;
            --text: #2b2d42;
            --gray: #adb5bd;
        }

        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
        }

        body {
            background: linear-gradient(135deg, #f5f7fa 0%, #c3cfe2 100%);
            min-height: 100vh;
            color: var(--text);
            line-height: 1.6;
        }

        .container {
            max-width: 1200px;
            margin: 0 auto;
            padding: 2rem;
        }

        /* Auth Container */
        .auth-container {
            display: flex;
            justify-content: center;
            align-items: center;
            min-height: 80vh;
        }

        .auth-box {
            background: white;
            border-radius: 16px;
            padding: 2.5rem;
            width: 100%;
            max-width: 500px;
            box-shadow: 0 10px 30px rgba(0,0,0,0.1);
        }

        .auth-header {
            text-align: center;
            margin-bottom: 2rem;
        }

        .auth-header h2 {
            color: var(--primary);
            margin-bottom: 0.5rem;
        }

        .auth-tabs {
            display: flex;
            justify-content: center;
            margin-bottom: 1.5rem;
        }

        .auth-tab {
            padding: 0.8rem 1.5rem;
            cursor: pointer;
            font-weight: 600;
            color: var(--gray);
            border-bottom: 3px solid transparent;
            transition: all 0.3s;
        }

        .auth-tab.active {
            color: var(--primary);
            border-bottom-color: var(--primary);
        }

        .form-group {
            margin-bottom: 1.5rem;
        }

        .form-group label {
            display: block;
            margin-bottom: 0.5rem;
            font-weight: 600;
            color: var(--text);
        }

        .form-control {
            width: 100%;
            padding: 0.8rem 1rem;
            border: 2px solid #e9ecef;
            border-radius: 8px;
            font-size: 1rem;
            transition: border-color 0.3s;
        }

        .form-control:focus {
            outline: none;
            border-color: var(--accent);
        }

        .btn {
            background: linear-gradient(135deg, var(--primary) 0%, var(--secondary) 100%);
            color: white;
            border: none;
            padding: 0.8rem 1.8rem;
            border-radius: 50px;
            font-size: 1rem;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s;
            box-shadow: 0 4px 15px rgba(67, 97, 238, 0.3);
            width: 100%;
        }

        .btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 6px 20px rgba(67, 97, 238, 0.4);
        }

        .btn:active {
            transform: translateY(0);
        }

        .auth-footer {
            text-align: center;
            margin-top: 1.5rem;
            color: var(--gray);
        }

        .auth-footer a {
            color: var(--primary);
            text-decoration: none;
            font-weight: 600;
        }

        .error-message {
            color: var(--danger);
            margin-top: 0.5rem;
            font-size: 0.9rem;
        }

        /* Main App (hidden initially) */
        #mainApp {
            display: none;
        }

        /* Header */
        header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 2rem;
            padding-bottom: 1rem;
            border-bottom: 1px solid rgba(0,0,0,0.1);
        }

        .logo {
            font-size: 1.8rem;
            font-weight: 700;
            color: var(--primary);
        }

        .user-info {
            display: flex;
            align-items: center;
        }

        .user-email {
            margin-right: 1rem;
            font-weight: 600;
        }

        .logout-btn {
            background: var(--danger);
            color: white;
            border: none;
            padding: 0.5rem 1rem;
            border-radius: 50px;
            font-size: 0.9rem;
            cursor: pointer;
            transition: all 0.3s;
        }

        .logout-btn:hover {
            background: #d1146b;
        }

        /* Tabs */
        .tabs {
            display: flex;
            margin-bottom: 2rem;
            border-bottom: 1px solid rgba(0,0,0,0.1);
        }

        .tab {
            padding: 0.8rem 1.5rem;
            cursor: pointer;
            font-weight: 600;
            color: var(--gray);
            border-bottom: 3px solid transparent;
            transition: all 0.3s;
        }

        .tab.active {
            color: var(--primary);
            border-bottom-color: var(--primary);
        }

        /* Quiz Container */
        #secureQuizContainer {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: white;
            z-index: 1000;
            flex-direction: column;
            box-shadow: 0 0 30px rgba(0,0,0,0.1);
        }

        /* Quiz Header */
        #quizHeader {
            padding: 1.5rem;
            background: linear-gradient(135deg, var(--primary) 0%, var(--secondary) 100%);
            color: white;
            display: flex;
            justify-content: space-between;
            align-items: center;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
        }

        #quizTitleDisplay {
            font-size: 1.5rem;
            font-weight: 600;
        }

        #quizTimer {
            font-size: 1.2rem;
            font-weight: 700;
            background: rgba(255,255,255,0.2);
            padding: 0.5rem 1rem;
            border-radius: 50px;
            min-width: 90px;
            text-align: center;
        }

        .time-warning {
            color: #ffd166;
            animation: pulse 1s infinite;
        }

        .time-critical {
            color: #ef476f;
            animation: pulse 0.5s infinite;
        }

        @keyframes pulse {
            0% { transform: scale(1); }
            50% { transform: scale(1.05); }
            100% { transform: scale(1); }
        }

        /* Quiz Content */
        #quizContent {
            padding: 2rem;
            max-width: 800px;
            margin: 0 auto;
            width: 100%;
            overflow-y: auto;
            flex-grow: 1;
        }

        .quiz-question {
            margin-bottom: 2rem;
            padding: 1.5rem;
            border-radius: 12px;
            background: white;
            box-shadow: 0 5px 15px rgba(0,0,0,0.05);
            border: 1px solid rgba(0,0,0,0.05);
            transition: transform 0.3s, box-shadow 0.3s;
        }

        .quiz-question:hover {
            transform: translateY(-3px);
            box-shadow: 0 8px 25px rgba(0,0,0,0.1);
        }

        .quiz-question h4 {
            margin-bottom: 1.5rem;
            color: var(--primary);
            font-size: 1.1rem;
        }

        .mcq-option {
            display: block;
            margin: 0.8rem 0;
            padding: 1rem;
            border: 2px solid #e9ecef;
            border-radius: 8px;
            cursor: pointer;
            transition: all 0.3s;
            font-weight: 500;
        }

        .mcq-option:hover {
            background: #f8f9fa;
            border-color: var(--accent);
        }

        .mcq-option.selected {
            background: rgba(72, 149, 239, 0.1);
            border-color: var(--accent);
            color: var(--primary);
        }

        .written-answer {
            width: 100%;
            padding: 1rem;
            border: 2px solid #e9ecef;
            border-radius: 8px;
            min-height: 120px;
            resize: vertical;
            font-size: 1rem;
            transition: border-color 0.3s;
        }

        .written-answer:focus {
            outline: none;
            border-color: var(--accent);
        }

        /* Quiz Controls */
        #quizControls {
            padding: 1.5rem;
            background: white;
            display: flex;
            justify-content: center;
            box-shadow: 0 -2px 10px rgba(0,0,0,0.05);
        }

        /* Buttons */
        .btn-success {
            background: linear-gradient(135deg, #4cc9f0 0%, #4895ef 100%);
            box-shadow: 0 4px 15px rgba(76, 201, 240, 0.3);
        }

        /* Modals */
        .modal {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0,0,0,0.7);
            z-index: 2000;
            align-items: center;
            justify-content: center;
        }

        .modal-content {
            background: white;
            border-radius: 16px;
            padding: 2rem;
            width: 90%;
            max-width: 600px;
            max-height: 90vh;
            overflow-y: auto;
            box-shadow: 0 10px 30px rgba(0,0,0,0.2);
            animation: modalFadeIn 0.3s;
        }

        @keyframes modalFadeIn {
            from { opacity: 0; transform: translateY(-20px); }
            to { opacity: 1; transform: translateY(0); }
        }

        .close {
            color: var(--gray);
            float: right;
            font-size: 1.8rem;
            font-weight: bold;
            cursor: pointer;
            transition: color 0.3s;
        }

        .close:hover {
            color: var(--dark);
        }

        /* Results */
        .quiz-result-item {
            margin-bottom: 1rem;
            padding: 1.2rem;
            border-radius: 10px;
            transition: all 0.3s;
        }

        .quiz-result-item:hover {
            transform: translateX(5px);
        }

        .result-correct {
            background: rgba(76, 201, 240, 0.1);
            border-left: 4px solid var(--success);
        }

        .result-incorrect {
            background: rgba(247, 37, 133, 0.05);
            border-left: 4px solid var(--danger);
        }

        .result-score-outstanding {
            color: var(--primary);
            font-weight: 700;
        }

        .result-score-good {
            color: var(--success);
            font-weight: 700;
        }

        .result-score-poor {
            color: var(--danger);
            font-weight: 700;
        }

        /* Teacher Dashboard */
        .quiz-card {
            background: white;
            border-radius: 12px;
            padding: 1.5rem;
            margin-bottom: 1.5rem;
            box-shadow: 0 5px 15px rgba(0,0,0,0.05);
            transition: transform 0.3s, box-shadow 0.3s;
        }

        .quiz-card:hover {
            transform: translateY(-3px);
            box-shadow: 0 8px 25px rgba(0,0,0,0.1);
        }

        .quiz-card-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 1rem;
        }

        .quiz-card-title {
            font-size: 1.2rem;
            font-weight: 600;
            color: var(--primary);
        }

        .quiz-card-subject {
            display: inline-block;
            padding: 0.3rem 0.8rem;
            background: rgba(67, 97, 238, 0.1);
            color: var(--primary);
            border-radius: 50px;
            font-size: 0.8rem;
            font-weight: 600;
        }

        .quiz-card-details {
            display: flex;
            margin-bottom: 1rem;
            color: var(--gray);
            font-size: 0.9rem;
        }

        .quiz-card-detail {
            margin-right: 1.5rem;
            display: flex;
            align-items: center;
        }

        .quiz-card-detail i {
            margin-right: 0.5rem;
        }

        .quiz-card-actions {
            display: flex;
            justify-content: flex-end;
        }

        .btn-sm {
            padding: 0.5rem 1rem;
            font-size: 0.9rem;
            margin-left: 0.5rem;
        }

        /* Create Quiz Form */
        .create-quiz-form {
            background: white;
            border-radius: 12px;
            padding: 2rem;
            box-shadow: 0 5px 15px rgba(0,0,0,0.05);
        }

        .form-row {
            display: flex;
            margin-bottom: 1.5rem;
        }

        .form-col {
            flex: 1;
            margin-right: 1.5rem;
        }

        .form-col:last-child {
            margin-right: 0;
        }

        /* Student Dashboard */
        .available-quiz-card {
            background: white;
            border-radius: 12px;
            padding: 1.5rem;
            margin-bottom: 1.5rem;
            box-shadow: 0 5px 15px rgba(0,0,0,0.05);
            transition: transform 0.3s, box-shadow 0.3s;
        }

        .available-quiz-card:hover {
            transform: translateY(-3px);
            box-shadow: 0 8px 25px rgba(0,0,0,0.1);
        }

        .quiz-status {
            display: inline-block;
            padding: 0.3rem 0.8rem;
            border-radius: 50px;
            font-size: 0.8rem;
            font-weight: 600;
        }

        .status-active {
            background: rgba(76, 201, 240, 0.1);
            color: var(--success);
        }

        .status-upcoming {
            background: rgba(255, 193, 7, 0.1);
            color: #ffc107;
        }

        .status-ended {
            background: rgba(108, 117, 125, 0.1);
            color: #6c757d;
        }

        /* Responsive Design */
        @media (max-width: 768px) {
            .container {
                padding: 1rem;
            }

            .auth-box {
                padding: 1.5rem;
            }

            .form-row {
                flex-direction: column;
            }

            .form-col {
                margin-right: 0;
                margin-bottom: 1rem;
            }

            #quizContent {
                padding: 1rem;
            }

            .quiz-question {
                padding: 1rem;
            }

            .modal-content {
                padding: 1.5rem;
            }
        }
    </style>
    <!-- Updated Firebase SDK includes with crossorigin attribute -->
    <script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-app.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-auth.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-firestore.js"></script>
</head>
<body>
    <!-- Authentication Container -->
    <div class="auth-container" id="authContainer">
        <div class="auth-box">
            <div class="auth-header">
                <h2>Academia Nova</h2>
                <p>Secure Learning Portal</p>
            </div>
            
            <div class="auth-tabs">
                <div class="auth-tab active" id="loginTab">Login</div>
                <div class="auth-tab" id="signupTab">Sign Up</div>
            </div>
            
            <div id="loginForm">
                <div class="form-group">
                    <label for="loginEmail">Email</label>
                    <input type="email" id="loginEmail" class="form-control" placeholder="Enter your email">
                </div>
                
                <div class="form-group">
                    <label for="loginPassword">Password</label>
                    <input type="password" id="loginPassword" class="form-control" placeholder="Enter your password">
                </div>
                
                <div id="loginError" class="error-message"></div>
                
                <button class="btn" id="loginBtn">Login</button>
                
                <div class="auth-footer">
                    Don't have an account? <a href="#" id="showSignup">Sign up</a>
                </div>
            </div>
            
            <div id="signupForm" style="display: none;">
                <div class="form-group">
                    <label for="signupEmail">Email</label>
                    <input type="email" id="signupEmail" class="form-control" placeholder="Enter your email">
                </div>
                
                <div class="form-group">
                    <label for="signupPassword">Password</label>
                    <input type="password" id="signupPassword" class="form-control" placeholder="Create a password">
                </div>
                
                <div class="form-group">
                    <label for="signupConfirmPassword">Confirm Password</label>
                    <input type="password" id="signupConfirmPassword" class="form-control" placeholder="Confirm your password">
                </div>
                
                <div class="form-group">
                    <label for="userType">I am a:</label>
                    <select id="userType" class="form-control">
                        <option value="student">Student</option>
                        <option value="teacher">Teacher</option>
                    </select>
                </div>
                
                <div id="signupError" class="error-message"></div>
                
                <button class="btn" id="signupBtn">Create Account</button>
                
                <div class="auth-footer">
                    Already have an account? <a href="#" id="showLogin">Login</a>
                </div>
            </div>
        </div>
    </div>
    
    <!-- Main Application (hidden initially) -->
    <div id="mainApp">
        <div class="container">
            <header>
                <div class="logo">Academia Nova</div>
                <div class="user-info">
                    <span class="user-email" id="userEmailDisplay"></span>
                    <button class="logout-btn" id="logoutBtn">Logout</button>
                </div>
            </header>
            
            <div class="tabs">
                <div class="tab active" id="dashboardTab">Dashboard</div>
                <div class="tab" id="createQuizTab" style="display: none;">Create Quiz</div>
                <div class="tab" id="resultsTab">Results</div>
            </div>
            
            <!-- Teacher Dashboard -->
            <div id="teacherDashboard" style="display: none;">
                <h2 style="margin-bottom: 1.5rem;">My Quizzes</h2>
                <button class="btn" id="createNewQuizBtn">Create New Quiz</button>
                
                <div id="teacherQuizzesList">
                    <!-- Quizzes will be loaded here -->
                </div>
            </div>
            
            <!-- Create Quiz Form -->
            <div id="createQuizForm" style="display: none;">
                <h2 style="margin-bottom: 1.5rem;">Create New Quiz</h2>
                
                <div class="create-quiz-form">
                    <div class="form-row">
                        <div class="form-col">
                            <div class="form-group">
                                <label for="quizTitle">Quiz Title</label>
                                <input type="text" id="quizTitle" class="form-control" placeholder="Enter quiz title">
                            </div>
                        </div>
                        <div class="form-col">
                            <div class="form-group">
                                <label for="quizSubject">Subject</label>
                                <select id="quizSubject" class="form-control">
                                    <option value="MATH11">MATH11</option>
                                    <option value="MATH12">MATH12</option>
                                    <option value="PHYC11">PHYC11</option>
                                    <option value="PHYC12">PHYC12</option>
                                </select>
                            </div>
                        </div>
                    </div>
                    
                    <div class="form-row">
                        <div class="form-col">
                            <div class="form-group">
                                <label for="quizStartDate">Start Date & Time</label>
                                <input type="datetime-local" id="quizStartDate" class="form-control">
                            </div>
                        </div>
                        <div class="form-col">
                            <div class="form-group">
                                <label for="quizEndDate">End Date & Time</label>
                                <input type="datetime-local" id="quizEndDate" class="form-control">
                            </div>
                        </div>
                    </div>
                    
                    <div class="form-row">
                        <div class="form-col">
                            <div class="form-group">
                                <label for="quizDuration">Duration (minutes)</label>
                                <input type="number" id="quizDuration" class="form-control" placeholder="Enter duration in minutes">
                            </div>
                        </div>
                        <div class="form-col">
                            <div class="form-group">
                                <label for="quizTotalMarks">Total Marks</label>
                                <input type="number" id="quizTotalMarks" class="form-control" placeholder="Enter total marks">
                            </div>
                        </div>
                    </div>
                    
                    <div id="quizQuestionsContainer">
                        <!-- Questions will be added here -->
                    </div>
                    
                    <div style="text-align: center; margin: 2rem 0;">
                        <button class="btn" id="addQuestionBtn">Add Question</button>
                    </div>
                    
                    <div class="form-group" style="text-align: center;">
                        <button class="btn btn-success" id="saveQuizBtn">Save Quiz</button>
                        <button class="btn" id="cancelQuizBtn" style="margin-left: 1rem;">Cancel</button>
                    </div>
                </div>
            </div>
            
            <!-- Student Dashboard -->
            <div id="studentDashboard" style="display: none;">
                <h2 style="margin-bottom: 1.5rem;">Available Quizzes</h2>
                
                <div id="availableQuizzesList">
                    <!-- Available quizzes will be loaded here -->
                </div>
                
                <h2 style="margin-bottom: 1.5rem; margin-top: 2rem;">Completed Quizzes</h2>
                
                <div id="completedQuizzesList">
                    <!-- Completed quizzes will be loaded here -->
                </div>
            </div>
            
            <!-- Results Dashboard -->
            <div id="resultsDashboard" style="display: none;">
                <h2 style="margin-bottom: 1.5rem;">Quiz Results</h2>
                
                <div id="resultsList">
                    <!-- Results will be loaded here -->
                </div>
            </div>
        </div>
    </div>
    
    <!-- Secure Quiz Interface -->
    <div id="secureQuizContainer">
        <div id="quizHeader">
            <h2 id="quizTitleDisplay">Algebra Assessment</h2>
            <div id="quizTimer">20:00</div>
        </div>
        
        <div id="quizContent">
            <!-- Questions will be loaded here dynamically -->
        </div>
        
        <div id="quizControls">
            <button class="btn btn-success" id="submitQuizBtn">Submit Quiz</button>
        </div>
    </div>

    <!-- Exit Warning Modal -->
    <div id="exitWarningModal" class="modal">
        <div class="modal-content">
            <span class="close" onclick="resumeQuiz()">&times;</span>
            <h3 style="color: var(--danger); margin-bottom: 1rem;">⚠️ Quiz Integrity Warning</h3>
            <p style="margin-bottom: 1rem;">You have attempted to exit full-screen mode. This is not allowed during quizzes.</p>
            <p style="margin-bottom: 1.5rem; font-weight: 500;">You have <span id="exitWarningCount" style="font-weight: 700;">2</span> warnings remaining before your quiz will be automatically submitted.</p>
            <button class="btn" onclick="resumeQuiz()">Return to Quiz</button>
        </div>
    </div>

    <!-- Results Modal -->
    <div id="quizResultModal" class="modal">
        <div class="modal-content">
            <span class="close" onclick="closeModal('quizResultModal')">&times;</span>
            <h3 id="resultQuizTitle" style="color: var(--primary); margin-bottom: 1.5rem;">Quiz Results</h3>
            <div id="quizResultContent">
                <!-- Results will be loaded here dynamically -->
            </div>
        </div>
    </div>

    <script>
        // Firebase configuration
        const firebaseConfig = {
            apiKey: "AIzaSyBNw2WwJmgIIAtCs-iCqlQRLHHnlsRF1lU",
            authDomain: "my-nova-portal.firebaseapp.com",
            projectId: "my-nova-portal",
            storageBucket: "my-nova-portal.appspot.com",
            messagingSenderId: "866806770205",
            appId: "1:866806770205:web:44c96ab19965ef37b134f4",
            measurementId: "G-HGF270KCRL"
        };

        // Initialize Firebase
        firebase.initializeApp(firebaseConfig);
const auth = firebase.auth();
const db = firebase.firestore();

        // Current user data
        let currentUser = null;
        let userType = null;

        // Quiz state variables
        let currentQuiz = null;
        let quizTimer = null;
        let timeRemaining = 0;
        let exitWarningsLeft = 3;
        let userAnswers = [];

        // DOM elements
        const authContainer = document.getElementById('authContainer');
        const mainApp = document.getElementById('mainApp');
        const loginForm = document.getElementById('loginForm');
        const signupForm = document.getElementById('signupForm');
        const loginTab = document.getElementById('loginTab');
        const signupTab = document.getElementById('signupTab');
        const showLogin = document.getElementById('showLogin');
        const showSignup = document.getElementById('showSignup');
        const loginBtn = document.getElementById('loginBtn');
        const signupBtn = document.getElementById('signupBtn');
        const loginEmail = document.getElementById('loginEmail');
        const loginPassword = document.getElementById('loginPassword');
        const signupEmail = document.getElementById('signupEmail');
        const signupPassword = document.getElementById('signupPassword');
        const signupConfirmPassword = document.getElementById('signupConfirmPassword');
        const userTypeSelect = document.getElementById('userType');
        const loginError = document.getElementById('loginError');
        const signupError = document.getElementById('signupError');
        const logoutBtn = document.getElementById('logoutBtn');
        const userEmailDisplay = document.getElementById('userEmailDisplay');
        const dashboardTab = document.getElementById('dashboardTab');
        const createQuizTab = document.getElementById('createQuizTab');
        const resultsTab = document.getElementById('resultsTab');
        const teacherDashboard = document.getElementById('teacherDashboard');
        const studentDashboard = document.getElementById('studentDashboard');
        const resultsDashboard = document.getElementById('resultsDashboard');
        const teacherQuizzesList = document.getElementById('teacherQuizzesList');
        const availableQuizzesList = document.getElementById('availableQuizzesList');
        const completedQuizzesList = document.getElementById('completedQuizzesList');
        const resultsList = document.getElementById('resultsList');
        const createNewQuizBtn = document.getElementById('createNewQuizBtn');
        const createQuizForm = document.getElementById('createQuizForm');
        const quizTitle = document.getElementById('quizTitle');
        const quizSubject = document.getElementById('quizSubject');
        const quizStartDate = document.getElementById('quizStartDate');
        const quizEndDate = document.getElementById('quizEndDate');
        const quizDuration = document.getElementById('quizDuration');
        const quizTotalMarks = document.getElementById('quizTotalMarks');
        const quizQuestionsContainer = document.getElementById('quizQuestionsContainer');
        const addQuestionBtn = document.getElementById('addQuestionBtn');
        const saveQuizBtn = document.getElementById('saveQuizBtn');
        const cancelQuizBtn = document.getElementById('cancelQuizBtn');
        const secureQuizContainer = document.getElementById('secureQuizContainer');
        const quizTitleDisplay = document.getElementById('quizTitleDisplay');
        const quizTimerDisplay = document.getElementById('quizTimer');
        const quizContent = document.getElementById('quizContent');
        const submitQuizBtn = document.getElementById('submitQuizBtn');
        const exitWarningModal = document.getElementById('exitWarningModal');
        const exitWarningCountEl = document.getElementById('exitWarningCount');
        const quizResultModal = document.getElementById('quizResultModal');
        const resultQuizTitle = document.getElementById('resultQuizTitle');
        const quizResultContent = document.getElementById('quizResultContent');

        // Event Listeners
        loginTab.addEventListener('click', () => showAuthForm('login'));
        signupTab.addEventListener('click', () => showAuthForm('signup'));
        showLogin.addEventListener('click', () => showAuthForm('login'));
        showSignup.addEventListener('click', () => showAuthForm('signup'));
        loginBtn.addEventListener('click', loginUser);
        signupBtn.addEventListener('click', signupUser);
        logoutBtn.addEventListener('click', logoutUser);
        dashboardTab.addEventListener('click', () => showDashboard('dashboard'));
        createQuizTab.addEventListener('click', () => showDashboard('createQuiz'));
        resultsTab.addEventListener('click', () => showDashboard('results'));
        createNewQuizBtn.addEventListener('click', showCreateQuizForm);
        addQuestionBtn.addEventListener('click', addQuestionToForm);
        saveQuizBtn.addEventListener('click', saveQuiz);
        cancelQuizBtn.addEventListener('click', cancelQuizCreation);
        submitQuizBtn.addEventListener('click', submitSecureQuiz);

        // Initialize the app
        function init() {
            auth.onAuthStateChanged(user => {
                if (user) {
                    // User is signed in
                    currentUser = user;
                    userEmailDisplay.textContent = user.email;
                    
                    // Get user type from Firestore
                    db.collection('users').doc(user.uid).get().then(doc => {
                        if (doc.exists) {
                            userType = doc.data().userType;
                            
                            // Show appropriate dashboard
                            if (userType === 'teacher') {
                                createQuizTab.style.display = 'block';
                                showTeacherDashboard();
                            } else {
                                createQuizTab.style.display = 'none';
                                showStudentDashboard();
                            }
                            
                            authContainer.style.display = 'none';
                            mainApp.style.display = 'block';
                        } else {
                            // User document doesn't exist, sign them out
                            logoutUser();
                        }
                    }).catch(error => {
                        console.error('Error getting user document:', error);
                        logoutUser();
                    });
                } else {
                    // User is signed out
                    currentUser = null;
                    authContainer.style.display = 'flex';
                    mainApp.style.display = 'none';
                    showAuthForm('login');
                }
            });
        }

        // Show login or signup form
        function showAuthForm(form) {
            if (form === 'login') {
                loginForm.style.display = 'block';
                signupForm.style.display = 'none';
                loginTab.classList.add('active');
                signupTab.classList.remove('active');
                loginError.textContent = '';
            } else {
                loginForm.style.display = 'none';
                signupForm.style.display = 'block';
                loginTab.classList.remove('active');
                signupTab.classList.add('active');
                signupError.textContent = '';
            }
        }

        // Login user
        function loginUser() {
            const email = loginEmail.value;
            const password = loginPassword.value;
            
            if (!email || !password) {
                loginError.textContent = 'Please enter both email and password';
                return;
            }
            
            auth.signInWithEmailAndPassword(email, password)
                .then(userCredential => {
                    // Login successful, handled by auth state listener
                })
                .catch(error => {
                    loginError.textContent = getAuthErrorMessage(error);
                });
        }

        // Sign up user
        function signupUser() {
            const email = signupEmail.value;
            const password = signupPassword.value;
            const confirmPassword = signupConfirmPassword.value;
            const userType = userTypeSelect.value;
            
            // Validate inputs
            if (!email || !password || !confirmPassword) {
                signupError.textContent = 'Please fill in all fields';
                return;
            }
            
            if (password !== confirmPassword) {
                signupError.textContent = 'Passwords do not match';
                return;
            }
            
            if (password.length < 6) {
                signupError.textContent = 'Password must be at least 6 characters';
                return;
            }
            
            // Create user
            auth.createUserWithEmailAndPassword(email, password)
                .then(userCredential => {
                    // Add user to Firestore
                    return db.collection('users').doc(userCredential.user.uid).set({
                        email: email,
                        userType: userType,
                        createdAt: firebase.firestore.FieldValue.serverTimestamp()
                    });
                })
                .then(() => {
                    // Sign up successful, handled by auth state listener
                })
                .catch(error => {
                    signupError.textContent = getAuthErrorMessage(error);
                });
        }

        // Logout user
        function logoutUser() {
            auth.signOut().then(() => {
                // Logout successful, handled by auth state listener
            }).catch(error => {
                console.error('Logout error:', error);
            });
        }

        // Show appropriate dashboard
        function showDashboard(tab) {
            dashboardTab.classList.remove('active');
            createQuizTab.classList.remove('active');
            resultsTab.classList.remove('active');
            
            teacherDashboard.style.display = 'none';
            studentDashboard.style.display = 'none';
            resultsDashboard.style.display = 'none';
            createQuizForm.style.display = 'none';
            
            if (tab === 'dashboard') {
                dashboardTab.classList.add('active');
                if (userType === 'teacher') {
                    showTeacherDashboard();
                } else {
                    showStudentDashboard();
                }
            } else if (tab === 'createQuiz') {
                createQuizTab.classList.add('active');
                showCreateQuizForm();
            } else if (tab === 'results') {
                resultsTab.classList.add('active');
                showResultsDashboard();
            }
        }

        // Show teacher dashboard
        function showTeacherDashboard() {
            teacherDashboard.style.display = 'block';
            loadTeacherQuizzes();
        }

        // Show student dashboard
        function showStudentDashboard() {
            studentDashboard.style.display = 'block';
            loadAvailableQuizzes();
            loadCompletedQuizzes();
        }

        // Show results dashboard
        function showResultsDashboard() {
            resultsDashboard.style.display = 'block';
            loadResults();
        }

        // Show create quiz form
        function showCreateQuizForm() {
            teacherDashboard.style.display = 'none';
            createQuizForm.style.display = 'block';
            
            // Reset form
            quizTitle.value = '';
            quizSubject.value = 'MATH11';
            quizStartDate.value = '';
            quizEndDate.value = '';
            quizDuration.value = '';
            quizTotalMarks.value = '';
            quizQuestionsContainer.innerHTML = '';
            
            // Add first question
            addQuestionToForm();
        }

        // Add question to quiz form
        function addQuestionToForm() {
            const questionIndex = quizQuestionsContainer.children.length;
            const questionDiv = document.createElement('div');
            questionDiv.className = 'quiz-question-form';
            questionDiv.dataset.index = questionIndex;
            questionDiv.innerHTML = `
                <h4 style="margin-bottom: 1rem;">Question ${questionIndex + 1}</h4>
                <div class="form-group">
                    <label for="questionType${questionIndex}">Question Type</label>
                    <select id="questionType${questionIndex}" class="form-control question-type" onchange="changeQuestionType(${questionIndex})">
                        <option value="mcq">Multiple Choice</option>
                        <option value="written">Written Answer</option>
                    </select>
                </div>
                
                <div class="form-group">
                    <label for="questionText${questionIndex}">Question Text</label>
                    <textarea id="questionText${questionIndex}" class="form-control" rows="3" placeholder="Enter the question"></textarea>
                </div>
                
                <div class="form-group">
                    <label for="questionPoints${questionIndex}">Points</label>
                    <input type="number" id="questionPoints${questionIndex}" class="form-control" placeholder="Enter points" value="1">
                </div>
                
                <div id="questionOptions${questionIndex}" class="mcq-options">
                    <div class="form-group">
                        <label>Options (select the correct one)</label>
                        <div class="mcq-option">
                            <input type="radio" name="correctOption${questionIndex}" value="1" checked>
                            <input type="text" class="form-control option-text" placeholder="Option 1">
                        </div>
                        <div class="mcq-option">
                            <input type="radio" name="correctOption${questionIndex}" value="2">
                            <input type="text" class="form-control option-text" placeholder="Option 2">
                        </div>
                        <div class="mcq-option">
                            <input type="radio" name="correctOption${questionIndex}" value="3">
                            <input type="text" class="form-control option-text" placeholder="Option 3">
                        </div>
                        <div class="mcq-option">
                            <input type="radio" name="correctOption${questionIndex}" value="4">
                            <input type="text" class="form-control option-text" placeholder="Option 4">
                        </div>
                    </div>
                </div>
                
                <div id="writtenAnswer${questionIndex}" class="written-answer-container" style="display: none;">
                    <div class="form-group">
                        <label for="correctAnswer${questionIndex}">Correct Answer</label>
                        <textarea id="correctAnswer${questionIndex}" class="form-control" rows="3" placeholder="Enter the correct answer"></textarea>
                    </div>
                </div>
                
                <button class="btn btn-sm" style="background: var(--danger); margin-top: 1rem;" onclick="removeQuestion(${questionIndex})">Remove Question</button>
            `;
            
            quizQuestionsContainer.appendChild(questionDiv);
        }

        // Change question type
        function changeQuestionType(index) {
            const questionType = document.getElementById(`questionType${index}`).value;
            const mcqOptions = document.getElementById(`questionOptions${index}`);
            const writtenAnswer = document.getElementById(`writtenAnswer${index}`);
            
            if (questionType === 'mcq') {
                mcqOptions.style.display = 'block';
                writtenAnswer.style.display = 'none';
            } else {
                mcqOptions.style.display = 'none';
                writtenAnswer.style.display = 'block';
            }
        }

        // Remove question from form
        function removeQuestion(index) {
            const questionDiv = document.querySelector(`.quiz-question-form[data-index="${index}"]`);
            if (questionDiv) {
                quizQuestionsContainer.removeChild(questionDiv);
                
                // Update question numbers
                const questions = document.querySelectorAll('.quiz-question-form');
                questions.forEach((q, i) => {
                    q.dataset.index = i;
                    q.querySelector('h4').textContent = `Question ${i + 1}`;
                });
            }
        }

        // Save quiz to Firestore
        function saveQuiz() {
            const title = quizTitle.value.trim();
            const subject = quizSubject.value;
            const startDate = quizStartDate.value;
            const endDate = quizEndDate.value;
            const duration = parseInt(quizDuration.value);
            const totalMarks = parseInt(quizTotalMarks.value);
            
            // Validate inputs
            if (!title || !startDate || !endDate || !duration || !totalMarks) {
                alert('Please fill in all required fields');
                return;
            }
            
            const startTimestamp = new Date(startDate).getTime();
            const endTimestamp = new Date(endDate).getTime();
            
            if (endTimestamp <= startTimestamp) {
                alert('End date must be after start date');
                return;
            }
            
            // Get all questions
            const questions = [];
            const questionDivs = document.querySelectorAll('.quiz-question-form');
            
            if (questionDivs.length === 0) {
                alert('Please add at least one question');
                return;
            }
            
            let calculatedTotalMarks = 0;
            
            questionDivs.forEach(div => {
                const index = div.dataset.index;
                const type = document.getElementById(`questionType${index}`).value;
                const text = document.getElementById(`questionText${index}`).value.trim();
                const points = parseInt(document.getElementById(`questionPoints${index}`).value);
                
                if (!text || isNaN(points) || points <= 0) {
                    alert(`Please fill in all fields for Question ${parseInt(index) + 1}`);
                    throw new Error('Validation failed');
                }
                
                calculatedTotalMarks += points;
                
                if (type === 'mcq') {
                    const options = [];
                    const optionInputs = div.querySelectorAll('.option-text');
                    const correctOption = parseInt(div.querySelector('input[name="correctOption' + index + '"]:checked').value);
                    
                    optionInputs.forEach((input, i) => {
                        const optionText = input.value.trim();
                        if (!optionText) {
                            alert(`Please fill in all options for Question ${parseInt(index) + 1}`);
                            throw new Error('Validation failed');
                        }
                        options.push(optionText);
                    });
                    
                    questions.push({
                        type: 'mcq',
                        question: text,
                        options: options,
                        correctOption: correctOption,
                        points: points
                    });
                } else {
                    const correctAnswer = document.getElementById(`correctAnswer${index}`).value.trim();
                    if (!correctAnswer) {
                        alert(`Please provide a correct answer for Question ${parseInt(index) + 1}`);
                        throw new Error('Validation failed');
                    }
                    
                    questions.push({
                        type: 'written',
                        question: text,
                        correctAnswer: correctAnswer,
                        points: points
                    });
                }
            });
            
            if (calculatedTotalMarks !== totalMarks) {
                alert(`The sum of question points (${calculatedTotalMarks}) does not match the total marks (${totalMarks})`);
                return;
            }
            
            // Save to Firestore
            db.collection('quizzes').add({
                title: title,
                subject: subject,
                startDate: startTimestamp,
                endDate: endTimestamp,
                duration: duration,
                totalMarks: totalMarks,
                questions: questions,
                createdBy: currentUser.uid,
                createdAt: firebase.firestore.FieldValue.serverTimestamp()
            })
            .then(() => {
                alert('Quiz created successfully!');
                showTeacherDashboard();
            })
            .catch(error => {
                console.error('Error saving quiz:', error);
                alert('Failed to save quiz. Please try again.');
            });
        }

        // Cancel quiz creation
        function cancelQuizCreation() {
            showTeacherDashboard();
        }

        // Load teacher's quizzes
        function loadTeacherQuizzes() {
            teacherQuizzesList.innerHTML = '<p>Loading quizzes...</p>';
            
            db.collection('quizzes')
                .where('createdBy', '==', currentUser.uid)
                .orderBy('createdAt', 'desc')
                .get()
                .then(querySnapshot => {
                    if (querySnapshot.empty) {
                        teacherQuizzesList.innerHTML = '<p>No quizzes created yet.</p>';
                        return;
                    }
                    
                    teacherQuizzesList.innerHTML = '';
                    
                    querySnapshot.forEach(doc => {
                        const quiz = doc.data();
                        const quizId = doc.id;
                        const startDate = new Date(quiz.startDate);
                        const endDate = new Date(quiz.endDate);
                        const now = new Date();
                        
                        let status = 'Upcoming';
                        if (now >= startDate && now <= endDate) {
                            status = 'Active';
                        } else if (now > endDate) {
                            status = 'Ended';
                        }
                        
                        const quizCard = document.createElement('div');
                        quizCard.className = 'quiz-card';
                        quizCard.innerHTML = `
                            <div class="quiz-card-header">
                                <div class="quiz-card-title">${quiz.title}</div>
                                <div class="quiz-card-subject">${quiz.subject}</div>
                            </div>
                            <div class="quiz-card-details">
                                <div class="quiz-card-detail">
                                    <i>📅</i> ${startDate.toLocaleString()}
                                </div>
                                <div class="quiz-card-detail">
                                    <i>⏱️</i> ${quiz.duration} mins
                                </div>
                                <div class="quiz-card-detail">
                                    <i>🏆</i> ${quiz.totalMarks} marks
                                </div>
                            </div>
                            <div class="quiz-card-details">
                                <div class="quiz-card-detail">
                                    <i>📊</i> ${status}
                                </div>
                                <div class="quiz-card-detail">
                                    <i>👥</i> ${quiz.participants || 0} participants
                                </div>
                            </div>
                            <div class="quiz-card-actions">
                                ${status === 'Active' ? `<button class="btn btn-sm" onclick="viewQuizResults('${quizId}')">View Results</button>` : ''}
                                ${status === 'Upcoming' ? `<button class="btn btn-sm" onclick="editQuiz('${quizId}')">Edit</button>` : ''}
                                ${status === 'Upcoming' ? `<button class="btn btn-sm" style="background: var(--danger);" onclick="deleteQuiz('${quizId}')">Delete</button>` : ''}
                            </div>
                        `;
                        
                        teacherQuizzesList.appendChild(quizCard);
                    });
                })
                .catch(error => {
                    console.error('Error loading quizzes:', error);
                    teacherQuizzesList.innerHTML = '<p>Failed to load quizzes. Please try again.</p>';
                });
        }

        // Load available quizzes for students
        function loadAvailableQuizzes() {
            availableQuizzesList.innerHTML = '<p>Loading available quizzes...</p>';
            const now = new Date().getTime();
            
            db.collection('quizzes')
                .where('endDate', '>', now)
                .orderBy('endDate', 'asc')
                .get()
                .then(querySnapshot => {
                    if (querySnapshot.empty) {
                        availableQuizzesList.innerHTML = '<p>No quizzes available at the moment.</p>';
                        return;
                    }
                    
                    availableQuizzesList.innerHTML = '';
                    
                    querySnapshot.forEach(doc => {
                        const quiz = doc.data();
                        const quizId = doc.id;
                        const startDate = new Date(quiz.startDate);
                        const endDate = new Date(quiz.endDate);
                        const now = new Date();
                        
                        let status = 'upcoming';
                        let statusText = 'Upcoming';
                        if (now >= startDate && now <= endDate) {
                            status = 'active';
                            statusText = 'Active';
                        }
                        
                        // Check if student has already taken this quiz
                        db.collection('results')
                            .where('quizId', '==', quizId)
                            .where('studentId', '==', currentUser.uid)
                            .get()
                            .then(resultSnapshot => {
                                if (resultSnapshot.empty) {
                                    const quizCard = document.createElement('div');
                                    quizCard.className = 'available-quiz-card';
                                    quizCard.innerHTML = `
                                        <div class="quiz-card-header">
                                            <div class="quiz-card-title">${quiz.title}</div>
                                            <div class="quiz-card-subject">${quiz.subject}</div>
                                        </div>
                                        <div class="quiz-card-details">
                                            <div class="quiz-card-detail">
                                                <i>📅</i> ${startDate.toLocaleDateString()} - ${endDate.toLocaleDateString()}
                                            </div>
                                            <div class="quiz-card-detail">
                                                <i>⏱️</i> ${quiz.duration} mins
                                            </div>
                                            <div class="quiz-card-detail">
                                                <i>🏆</i> ${quiz.totalMarks} marks
                                            </div>
                                        </div>
                                        <div class="quiz-status status-${status}">${statusText}</div>
                                        ${status === 'active' ? 
                                            `<button class="btn btn-sm" style="margin-top: 1rem;" onclick="startQuiz('${quizId}')">Start Quiz</button>` : 
                                            `<div style="margin-top: 1rem; color: var(--gray);">Available at ${startDate.toLocaleString()}</div>`
                                        }
                                    `;
                                    
                                    availableQuizzesList.appendChild(quizCard);
                                }
                            });
                    });
                })
                .catch(error => {
                    console.error('Error loading available quizzes:', error);
                    availableQuizzesList.innerHTML = '<p>Failed to load quizzes. Please try again.</p>';
                });
        }

        // Load completed quizzes for students
        function loadCompletedQuizzes() {
            completedQuizzesList.innerHTML = '<p>Loading completed quizzes...</p>';
            
            db.collection('results')
                .where('studentId', '==', currentUser.uid)
                .orderBy('submittedAt', 'desc')
                .get()
                .then(querySnapshot => {
                    if (querySnapshot.empty) {
                        completedQuizzesList.innerHTML = '<p>No completed quizzes yet.</p>';
                        return;
                    }
                    
                    completedQuizzesList.innerHTML = '';
                    
                    querySnapshot.forEach(doc => {
                        const result = doc.data();
                        
                        db.collection('quizzes').doc(result.quizId).get().then(quizDoc => {
                            if (quizDoc.exists) {
                                const quiz = quizDoc.data();
                                const percentage = Math.round((result.score / quiz.totalMarks) * 100);
                                
                                const quizCard = document.createElement('div');
                                quizCard.className = 'quiz-card';
                                quizCard.innerHTML = `
                                    <div class="quiz-card-header">
                                        <div class="quiz-card-title">${quiz.title}</div>
                                        <div class="quiz-card-subject">${quiz.subject}</div>
                                    </div>
                                    <div class="quiz-card-details">
                                        <div class="quiz-card-detail">
                                            <i>📅</i> ${new Date(result.submittedAt).toLocaleString()}
                                        </div>
                                        <div class="quiz-card-detail">
                                            <i>🏆</i> ${result.score}/${quiz.totalMarks} (${percentage}%)
                                        </div>
                                    </div>
                                    <div class="quiz-card-actions">
                                        <button class="btn btn-sm" onclick="viewQuizResultDetails('${doc.id}')">View Details</button>
                                    </div>
                                `;
                                
                                completedQuizzesList.appendChild(quizCard);
                            }
                        });
                    });
                })
                .catch(error => {
                    console.error('Error loading completed quizzes:', error);
                    completedQuizzesList.innerHTML = '<p>Failed to load completed quizzes. Please try again.</p>';
                });
        }

        // Load results for teachers
        function loadResults() {
            resultsList.innerHTML = '<p>Loading results...</p>';

            // First, get all quizzes created by the current teacher
            db.collection('quizzes')
                .where('createdBy', '==', currentUser.uid)
                .get()
                .then(quizSnapshot => {
                    if (quizSnapshot.empty) {
                        resultsList.innerHTML = '<p>No quizzes created yet.</p>';
                        return;
                    }

                    const quizIds = quizSnapshot.docs.map(doc => doc.id);

                    // Now get all results for these quizzes
                    if (quizIds.length === 0) {
                        resultsList.innerHTML = '<p>No results available yet.</p>';
                        return;
                    }

                    // Firestore 'in' queries are limited to 10 items
                    const batchSize = 10;
                    let batches = [];
                    for (let i = 0; i < quizIds.length; i += batchSize) {
                        batches.push(quizIds.slice(i, i + batchSize));
                    }

                    let allResults = [];
                    let batchPromises = batches.map(batchIds => {
                        return db.collection('results')
                            .where('quizId', 'in', batchIds)
                            .get()
                            .then(resultSnapshot => {
                                resultSnapshot.forEach(doc => allResults.push({ id: doc.id, ...doc.data() }));
                            });
                    });

                    Promise.all(batchPromises).then(() => {
                        if (allResults.length === 0) {
                            resultsList.innerHTML = '<p>No results available yet.</p>';
                            return;
                        }

                        // Group results by quizId
                        const resultsByQuiz = {};
                        allResults.forEach(result => {
                            if (!resultsByQuiz[result.quizId]) resultsByQuiz[result.quizId] = [];
                            resultsByQuiz[result.quizId].push(result);
                        });

                        // Fetch quiz details for each quiz with results
                        const quizPromises = Object.keys(resultsByQuiz).map(quizId => {
                            return db.collection('quizzes').doc(quizId).get();
                        });

                        Promise.all(quizPromises).then(quizDocs => {
                            resultsList.innerHTML = '';

                            quizDocs.forEach(quizDoc => {
                                if (quizDoc.exists) {
                                    const quiz = quizDoc.data();
                                    const quizResults = resultsByQuiz[quizDoc.id];
                                    const averageScore = quizResults.reduce((sum, result) => sum + result.score, 0) / quizResults.length;
                                    const averagePercentage = Math.round((averageScore / quiz.totalMarks) * 100);
                                    
                                    const quizResultDiv = document.createElement('div');
                                    quizResultDiv.className = 'quiz-card';
                                    quizResultDiv.innerHTML = `
                                        <div class="quiz-card-header">
                                            <div class="quiz-card-title">${quiz.title}</div>
                                            <div class="quiz-card-subject">${quiz.subject}</div>
                                        </div>
                                        <div class="quiz-card-details">
                                            <div class="quiz-card-detail">
                                                <i>📅</i> ${new Date(quiz.startDate).toLocaleDateString()} - ${new Date(quiz.endDate).toLocaleDateString()}
                                            </div>
                                            <div class="quiz-card-detail">
                                                <i>👥</i> ${quizResults.length} participants
                                            </div>
                                            <div class="quiz-card-detail">
                                                <i>📊</i> Average: ${averagePercentage}%
                                            </div>
                                        </div>
                                        <div class="quiz-card-actions">
                                            <button class="btn btn-sm" onclick="viewQuizResults('${quizDoc.id}')">View All Results</button>
                                        </div>
                                    `;

                                    resultsList.appendChild(quizResultDiv);
                                }
                            });
                        });
                    });
                })
                .catch(error => {
                    console.error('Error loading results:', error);
                    resultsList.innerHTML = '<p>Failed to load results. Please try again.</p>';
                });
        }

        // Start quiz for student
        function startQuiz(quizId) {
            db.collection('quizzes').doc(quizId).get().then(doc => {
                if (doc.exists) {
                    const quiz = doc.data();
                    const now = new Date().getTime();
                    
                    // Check if quiz is active
                    if (now < quiz.startDate || now > quiz.endDate) {
                        alert('This quiz is not currently active');
                        return;
                    }
                    
                    // Check if student has already taken this quiz
                    db.collection('results')
                        .where('quizId', '==', quizId)
                        .where('studentId', '==', currentUser.uid)
                        .get()
                        .then(querySnapshot => {
                            if (!querySnapshot.empty) {
                                alert('You have already taken this quiz');
                                return;
                            }
                            
                            // Start the quiz
                            currentQuiz = {
                                id: quizId,
                                title: quiz.title,
                                duration: quiz.duration,
                                totalMarks: quiz.totalMarks,
                                questions: quiz.questions
                            };
                            
                            timeRemaining = quiz.duration * 60;
                            exitWarningsLeft = 3;
                            userAnswers = [];
                            
                            // Initialize quiz UI
                            quizTitleDisplay.textContent = currentQuiz.title;
                            quizContent.innerHTML = '';
                            
                            // Load questions
                            currentQuiz.questions.forEach((q, index) => {
                                const questionDiv = document.createElement('div');
                                questionDiv.className = 'quiz-question';
                                questionDiv.dataset.index = index;
                                questionDiv.dataset.type = q.type;
                                questionDiv.dataset.points = q.points;
                                
                                if (q.type === 'mcq') {
                                    questionDiv.innerHTML = `
                                        <h4>Question ${index + 1}: ${q.question} (${q.points} point${q.points > 1 ? 's' : ''})</h4>
                                        <div class="mcq-options-container">
                                            ${q.options.map((opt, i) => `
                                                <div class="mcq-option" data-option="${i + 1}">${opt}</div>
                                            `).join('')}
                                        </div>
                                        <input type="hidden" class="selected-option" value="">
                                    `;
                                } else {
                                    questionDiv.innerHTML = `
                                        <h4>Question ${index + 1}: ${q.question} (${q.points} point${q.points > 1 ? 's' : ''})</h4>
                                        <textarea class="written-answer" placeholder="Type your answer here"></textarea>
                                    `;
                                }
                                
                                quizContent.appendChild(questionDiv);
                            });
                            
                            // Set up MCQ option selection
                            document.querySelectorAll('.mcq-option').forEach(option => {
                                option.addEventListener('click', function() {
                                    const questionDiv = this.closest('.quiz-question');
                                    questionDiv.querySelectorAll('.mcq-option').forEach(opt => {
                                        opt.classList.remove('selected');
                                    });
                                    this.classList.add('selected');
                                    questionDiv.querySelector('.selected-option').value = this.dataset.option;
                                });
                            });
                            
                            // Start timer
                            updateTimerDisplay();
                            quizTimer = setInterval(updateQuizTimer, 1000);
                            
                            // Show quiz container
                            secureQuizContainer.style.display = 'flex';
                            
                            // Enter full-screen mode
                            if (document.documentElement.requestFullscreen) {
                                document.documentElement.requestFullscreen().catch(err => {
                                    console.error('Fullscreen error:', err);
                                });
                            }
                            
                            // Set up event listeners for security
                            document.addEventListener('fullscreenchange', handleFullscreenChange);
                            document.addEventListener('keydown', preventExitKeys);
                            document.addEventListener('contextmenu', preventContextMenu);
                            document.addEventListener('copy', preventCopy);
                            document.addEventListener('cut', preventCopy);
                            document.addEventListener('paste', preventCopy);
                            
                            // Focus on first question
                            document.querySelector('.quiz-question')?.scrollIntoView({ behavior: 'smooth' });
                        });
                }
            }).catch(error => {
                console.error('Error starting quiz:', error);
                alert('Failed to start quiz. Please try again.');
            });
        }

        // Timer functions
        function updateTimerDisplay() {
            const minutes = Math.floor(timeRemaining / 60);
            const seconds = timeRemaining % 60;
            
            quizTimerDisplay.textContent = `${minutes.toString().padStart(2, '0')}:${seconds.toString().padStart(2, '0')}`;
            
            // Update timer styling based on remaining time
            quizTimerDisplay.classList.remove('time-warning', 'time-critical');
            if (timeRemaining <= 300) { // 5 minutes
                quizTimerDisplay.classList.add('time-warning');
                if (timeRemaining <= 60) { // 1 minute
                    quizTimerDisplay.classList.add('time-critical');
                }
            }
        }

        function updateQuizTimer() {
            timeRemaining--;
            updateTimerDisplay();
            
            if (timeRemaining <= 0) {
                clearInterval(quizTimer);
                submitSecureQuiz();
            }
        }

        // Security functions
        function handleFullscreenChange() {
            if (!document.fullscreenElement) {
                exitWarningsLeft--;
                exitWarningCountEl.textContent = exitWarningsLeft;
                exitWarningModal.style.display = 'block';
                
                if (exitWarningsLeft <= 0) {
                    submitSecureQuiz();
                }
            }
        }

        function resumeQuiz() {
            exitWarningModal.style.display = 'none';
            
            if (document.documentElement.requestFullscreen) {
                document.documentElement.requestFullscreen().catch(err => {
                    console.error('Fullscreen error:', err);
                });
            }
        }

        function preventExitKeys(e) {
            // Prevent F11, Escape key
            if (e.key === 'F11' || e.key === 'Escape') {
                e.preventDefault();
            }
        }

        function preventContextMenu(e) {
            e.preventDefault();
        }

        function preventCopy(e) {
            e.preventDefault();
        }

        // Submit quiz
        function submitSecureQuiz() {
            clearInterval(quizTimer);
            
            // Remove security event listeners
            document.removeEventListener('fullscreenchange', handleFullscreenChange);
            document.removeEventListener('keydown', preventExitKeys);
            document.removeEventListener('contextmenu', preventContextMenu);
            document.removeEventListener('copy', preventCopy);
            document.removeEventListener('cut', preventCopy);
            document.removeEventListener('paste', preventCopy);
            
            // Exit fullscreen if still in it
            if (document.fullscreenElement) {
                document.exitFullscreen();
            }
            
            // Calculate results
            const questions = document.querySelectorAll('.quiz-question');
            let totalScore = 0;
            const results = [];
            
            questions.forEach((q, index) => {
                const questionData = currentQuiz.questions[index];
                let isCorrect = false;
                let userAnswer = '';
                
                if (questionData.type === 'mcq') {
                    const selectedOption = q.querySelector('.selected-option').value;
                    userAnswer = questionData.options[parseInt(selectedOption) - 1] || 'No answer';
                    isCorrect = selectedOption == questionData.correctOption;
                } else {
                    userAnswer = q.querySelector('.written-answer').value || 'No answer';
                    // For demo purposes, we'll auto-grade written answers
                    isCorrect = userAnswer.toLowerCase().trim() === questionData.correctAnswer.toLowerCase().trim();
                }
                
                if (isCorrect) {
                    totalScore += questionData.points;
                }
                
                results.push({
                    question: questionData.question,
                    userAnswer: userAnswer,
                    correctAnswer: questionData.type === 'mcq' 
                        ? questionData.options[questionData.correctOption - 1]
                        : questionData.correctAnswer,
                    isCorrect: isCorrect,
                    points: isCorrect ? questionData.points : 0,
                    maxPoints: questionData.points
                });
            });
            
            const percentage = Math.round((totalScore / currentQuiz.totalMarks) * 100);
            
            // Save results to Firestore
            db.collection('results').add({
                quizId: currentQuiz.id,
                quizTitle: currentQuiz.title,
                studentId: currentUser.uid,
                studentEmail: currentUser.email,
                score: totalScore,
                maxScore: currentQuiz.totalMarks,
                percentage: percentage,
                answers: results,
                submittedAt: firebase.firestore.FieldValue.serverTimestamp()
            })
            .then(() => {
                // Update quiz participant count
                db.collection('quizzes').doc(currentQuiz.id).update({
                    participants: firebase.firestore.FieldValue.increment(1)
                });
                
                // Display results
                showQuizResults(totalScore, currentQuiz.totalMarks, percentage, results);
                
                // Hide quiz container
                secureQuizContainer.style.display = 'none';
                
                // Reload student dashboard
                if (userType === 'student') {
                    loadAvailableQuizzes();
                    loadCompletedQuizzes();
                }
            })
            .catch(error => {
                console.error('Error saving results:', error);
                alert('Failed to save quiz results. Please contact your teacher.');
            });
        }

        function showQuizResults(score, maxScore, percentage, results) {
            resultQuizTitle.textContent = `${currentQuiz.title} - Results`;
            
            let resultsHtml = `
                <div style="margin-bottom: 2rem; text-align: center;">
                    <h3 style="margin-bottom: 0.5rem;">Your Score: ${score}/${maxScore}</h3>
                    <div style="font-size: 2rem; font-weight: 700; margin-bottom: 1rem; color: ${getScoreColor(percentage)};">
                        ${percentage}%
                    </div>
                    <div style="font-size: 1.2rem; margin-bottom: 1rem;">
                        ${getPerformanceMessage(percentage)}
                    </div>
                </div>
                <h4 style="margin-bottom: 1rem; color: var(--primary);">Question Breakdown:</h4>
            `;
            
            results.forEach((result, index) => {
                resultsHtml += `
                    <div class="quiz-result-item ${result.isCorrect ? 'result-correct' : 'result-incorrect'}">
                        <p style="font-weight: 600; margin-bottom: 0.5rem;">Question ${index + 1}: ${result.question}</p>
                        <p style="margin-bottom: 0.3rem;"><strong>Your answer:</strong> ${result.userAnswer}</p>
                        <p style="margin-bottom: 0.3rem;"><strong>Correct answer:</strong> ${result.correctAnswer}</p>
                        <p style="margin-bottom: 0.3rem;"><strong>Points:</strong> ${result.points}/${result.maxPoints}</p>
                    </div>
                `;
            });
            
            quizResultContent.innerHTML = resultsHtml;
            quizResultModal.style.display = 'block';
        }

        function getScoreColor(percentage) {
            if (percentage >= 90) return 'var(--primary)';
            if (percentage >= 70) return 'var(--success)';
            if (percentage >= 50) return '#ffd166';
            return 'var(--danger)';
        }

        function getPerformanceMessage(percentage) {
            if (percentage >= 90) return '🌟 Outstanding performance!';
            if (percentage >= 70) return '✅ Well done!';
            if (percentage >= 50) return '↗️ Good effort, keep improving!';
            return '⚠️ Needs improvement. Review the material and try again.';
        }

        function closeModal(modalId) {
            document.getElementById(modalId).style.display = 'none';
        }

        // View quiz results (for teachers)
        function viewQuizResults(quizId) {
            // Implement this to show all student results for a quiz
            alert('Viewing results for quiz: ' + quizId);
        }

        // View quiz result details (for students)
        function viewQuizResultDetails(resultId) {
            // Implement this to show detailed results for a student
            alert('Viewing result details: ' + resultId);
        }

        // Edit quiz (for teachers)
        function editQuiz(quizId) {
            // Implement this to allow editing of a quiz
            alert('Editing quiz: ' + quizId);
        }

        // Delete quiz (for teachers)
        function deleteQuiz(quizId) {
            if (confirm('Are you sure you want to delete this quiz? This cannot be undone.')) {
                db.collection('quizzes').doc(quizId).delete()
                    .then(() => {
                        loadTeacherQuizzes();
                    })
                    .catch(error => {
                        console.error('Error deleting quiz:', error);
                        alert('Failed to delete quiz. Please try again.');
                    });
            }
        }

        // Helper function to get auth error messages
        function getAuthErrorMessage(error) {
            switch (error.code) {
                case 'auth/invalid-email':
                    return 'Invalid email address';
                case 'auth/user-disabled':
                    return 'User account disabled';
                case 'auth/user-not-found':
                    return 'User not found';
                case 'auth/wrong-password':
                    return 'Incorrect password';
                case 'auth/email-already-in-use':
                    return 'Email already in use';
                case 'auth/operation-not-allowed':
                    return 'Operation not allowed';
                case 'auth/weak-password':
                    return 'Password is too weak';
                default:
                    return 'Error: ' + error.message;
            }
        }

        // Initialize the app
        init();
    </script>
</body>
</html>